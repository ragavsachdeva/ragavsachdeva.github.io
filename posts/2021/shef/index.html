<!DOCTYPE html>
<html>

  <head>
    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RGNX6G39ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-RGNX6G39ZX');
</script>


<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Ragav  Sachdeva | shef - bake state machines in ROS</title>
<meta name="description" content="">

<!-- Open Graph -->

<meta property="og:site_name" content="" />
<meta property="og:type" content="object" />
<meta property="og:title" content="" />
<meta property="og:url" content="/posts/2021/shef/" />
<meta property="og:description" content="shef - bake state machines in ROS" />
<meta property="og:image" content="/assets/img/prof_pic.svg" />


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500&display=swap" rel="stylesheet">
<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/.css" media="none" id="highlight_theme_light" />

<!-- Styles -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#000000">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/posts/2021/shef/">

<!-- Theming-->


    
<!-- MathJax -->
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       <span class="font-weight-bold">Ragav</span>   Sachdeva
      </a>
      
      <!-- Navbar Toogle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/research/">
                research
                
              </a>
          </li>
          
          
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      

<div class="post">

  <header class="post-header">
    <h1 class="post-title">shef - bake state machines in ROS</h1>
    <p class="post-meta">September 7, 2021</p>
  </header>

  <article class="post-content">
    <div style="border-style: solid; padding: 1em; margin-bottom:1em; border-width: thin;">
  <p><strong>Disclaimer</strong></p>

  <p>I built shef when I was working on final round of the <a href="https://www.nasa.gov/directorates/spacetech/centennial_challenges/space_robotics/index.html" target="\_blank">NASA Space Robotics Challenge Phase 2</a> (although the name “shef” was coined in retrospect). Frankly, I haven’t tested it outside of that project and there is a possibility that it might contain some typos or missing dependencies as a result of pulling it out of the codebase. However, my hope is that someone out there who is trying to quickly prototype state machines in ROS might find it useful. I don’t plan on maintaining this piece of code but if you add any exciting features to it that others may find useful, feel free to send a merge request!</p>

</div>

<p><a href="https://github.com/ragavsachdeva/shef" target="\_blank">shef</a> is a wrapper around <a href="http://wiki.ros.org/smach" target="\_blank">smach</a>, built with the intention of simplifying the process of creating and running complex hierarchical state machines in <a href="https://www.ros.org/" target="\_blank">ROS</a>.</p>

<p>Let’s look at an example:</p>

<p>Suppose you want to create a simple state machine that sequentially executes three states: <code class="language-plaintext highlighter-rouge">StateA</code>, <code class="language-plaintext highlighter-rouge">StateB</code> and <code class="language-plaintext highlighter-rouge">StateC</code>.</p>

<p>More information on <a href="#state">states</a> is provided later, but for now know that creating a state is as simple as implementing a <code class="language-plaintext highlighter-rouge">behaviour</code> function as follows:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre>    <span class="kn">from</span> <span class="nn">state_machine.base._base_state</span> <span class="kn">import</span> <span class="n">BaseState</span>

    <span class="k">class</span> <span class="nc">StateA</span><span class="p">(</span><span class="n">BaseState</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">conditions</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">conditions</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">behaviour</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Executing StateA"</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">StateB</span><span class="p">(</span><span class="n">BaseState</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">conditions</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">conditions</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">behaviour</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Executing StateB"</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">StateC</span><span class="p">(</span><span class="n">BaseState</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">conditions</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">conditions</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">behaviour</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Executing StateC"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now, having implemented each of these states, the next step is to define how the program must transition between them. For that, you’ll need to implement something called a <a href="#transition-state">transition state</a>. In our case, a transition state that executes <code class="language-plaintext highlighter-rouge">StateA</code>, <code class="language-plaintext highlighter-rouge">StateB</code> and <code class="language-plaintext highlighter-rouge">StateC</code> sequentially might look something like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>    <span class="kn">from</span> <span class="nn">state_machine.states.base._base_transition_state</span> <span class="kn">import</span> <span class="n">BaseTransitionState</span>

    <span class="k">class</span> <span class="nc">CustomTransitionState</span><span class="p">(</span><span class="n">BaseTransitionState</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">ledger</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">ledger</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">def</span> <span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">child_states</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">index</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Finally, all we need to do is hook all of these individual states up into a state machine which can then be executed. That is done by defining a recipe file as:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>    <span class="na">root</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">SimpleStateMachine</span>
      <span class="na">transition_state</span><span class="pi">:</span> <span class="s">CustomTransitionState</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">state_a</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">StateA</span>
        <span class="na">state_b</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">StateB</span>
        <span class="na">state_c</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">StateC</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>and… that’s it! Everything else is taken care of for you by <a href="https://github.com/ragavsachdeva/shef" target="\_blank">shef</a>. shef will parse this recipe file, construct a smach state machine under-the-hood and execute the states as per the transitions you define (to run the program modify the provided <code class="language-plaintext highlighter-rouge">main.py</code>). It’s that simple!</p>

<p>Note that this was a very rudimentary example by design. shef allows you to do a lot more complex stuff with relative ease. This includes</p>

<ul>
  <li>running states in parallel</li>
  <li>nesting state machines</li>
  <li>synchronisation e.g. “do not execute stateX while stateY is running” or “wait for stateB to finish before executing stateA” etc.</li>
  <li>preempt execution</li>
  <li>externally force state transition</li>
</ul>

<p>and more. Keep reading for details!</p>

<h4 id="table-of-contents">Table of Contents</h4>
<ul>
  <li><a href="#state">State</a></li>
  <li><a href="#state-machine">State Machine</a>
    <ul>
      <li><a href="#concurrentstatemachine">ConcurrentStateMachine</a></li>
      <li><a href="#simplestatemachine">SimpleStateMachine</a></li>
    </ul>
  </li>
  <li><a href="#transition-state">Transition State</a></li>
  <li><a href="#recipes">Recipes</a></li>
  <li><a href="#monitor">Monitor</a></li>
  <li><a href="#synchronisation">Synchronisation</a></li>
</ul>

<h4 id="state">State</h4>

<p>A state is the simplest element of the state machine which “does something” when its <code class="language-plaintext highlighter-rouge">behaviour</code> function is executed. In order to define your own state you will need to inherit the <code class="language-plaintext highlighter-rouge">BaseState</code> class and implement the <code class="language-plaintext highlighter-rouge">behaviour</code> function.</p>

<p>Here is an example of a custom state class:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">state_machine.base._base_state</span> <span class="kn">import</span> <span class="n">BaseState</span>

<span class="k">class</span> <span class="nc">BusyWait</span><span class="p">(</span><span class="n">BaseState</span><span class="p">):</span>
    <span class="s">"""
    A simple state that infinitely busy-waits unless preempted.
    """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcome</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcome</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">behaviour</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="n">loginfo</span><span class="p">(</span>
            <span class="s">"Running the BusyWait. </span><span class="se">\
</span><span class="s">            Expected behaviour is to infinitely wait unless pre-emptively killed."</span>
        <span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">preempt_requested</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="n">rospy</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>and that is it really.</p>

<p><strong>YSK</strong></p>

<ul>
  <li>
    <p>Each state has a <code class="language-plaintext highlighter-rouge">self.data_store</code> dictionary object which is shared across all states (including the transition state) within a SimpleStateMachine. If you want to share data or pass messages to the sibling states, you can simply add it to the <code class="language-plaintext highlighter-rouge">data_store</code>.</p>
  </li>
  <li>
    <p>The state’s data is persistent. In other words, any variables that you declare in the constructor of the state class will “remember” their value if the state machine enters the same state again. If you want to reset these parameters every time this state is executed, you should either initialise them in the <code class="language-plaintext highlighter-rouge">behaviour</code> function or reset them in the <code class="language-plaintext highlighter-rouge">self.tear_down</code> function which is inherited from <code class="language-plaintext highlighter-rouge">BaseState</code>.</p>
  </li>
  <li>
    <p>Inside the <code class="language-plaintext highlighter-rouge">behaviour</code> function, you should have some logic to exit the function if <code class="language-plaintext highlighter-rouge">self.preempt_requested()</code> flag returns true. See the code above for example. This is required to preempt the state. If your state takes a long time to execute, you should be frequently monitoring this flag (and not just once).</p>
  </li>
</ul>

<h4 id="state-machine">State Machine</h4>

<p>A state machine is a container for a set of child states. There are two kinds of state machines that are implemented in <a href="https://github.com/ragavsachdeva/shef" target="\_blank">shef</a> by default:</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0" style="text-align: center; padding: 50px;">
        <img class="img-fluid rounded" src="/assets/img/blog_posts/2021-09-07-shef/state-machines.png" />
    </div>
</div>

<h5 id="concurrentstatemachine">ConcurrentStateMachine</h5>

<p>The concept of a concurrent state machine is quite straightforward. It runs all of its child states in concurrence (“in parallel”) and exits once all of them have finished executing.</p>

<h5 id="simplestatemachine">SimpleStateMachine</h5>

<p>Despite the name, a simple state machine is a bit more complex than a concurrent state machine. The idea for this state machine is to execute its child states one at a time based on some pre-defined logic (transitions). Rather than allowing any child state to transition to any other child states, there is a <a href="Transition State">transition state</a> which all <a href="#state">other states</a> are connected to. It is the responsibility of this transition state to manage the control flow of the program.</p>

<p><strong>YSK</strong></p>

<ul>
  <li>As evident from the diagram above, it is possible to nest state machines.</li>
  <li>In a SimpleStateMachine, there will only be one active state at a time.</li>
  <li>Both SimpleStateMachine and ConcurrentStateMachine come with a <a href="#monitor">monitor</a>. This monitor sets up a rostopic and constantly listens to it for any messages. A state machine can be preempted or forced to execute a particular state by publishing a message to its corresponding monitor.</li>
</ul>

<h4 id="transition-state">Transition State</h4>

<p>In order to define your own state you will need to inherit the <code class="language-plaintext highlighter-rouge">BaseTransitionState</code> class and implement the <code class="language-plaintext highlighter-rouge">next_state</code> function.</p>

<p>Here is an example of a custom transition state class:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="kn">from</span> <span class="nn">state_machine.base._base_transition_state</span> <span class="kn">import</span> <span class="n">BaseTransitionState</span>

<span class="k">class</span> <span class="nc">SequentialTransitionState</span><span class="p">(</span><span class="n">BaseTransitionState</span><span class="p">):</span>
    <span class="s">"""
    Transition state to sequentially execute all the child states.
    """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">ledger</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">ledger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">next_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">last_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">child_states</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">last_state</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">child_states</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The logic to decide which state to go to next should reside inside the <code class="language-plaintext highlighter-rouge">next_state</code> function. In the example above, the transition state sequentially executes the <a href="#state">states</a> in the order they were defined in the <a href="#recipes">recipe</a> file.</p>

<p><strong>YSK</strong></p>

<ul>
  <li>
    <p>Each transition state has <code class="language-plaintext highlighter-rouge">self.child_states</code> which is a list of strings representing the name of the <a href="#state">states</a> inside the SimpleStateMachine. To “go to” a particular state next, simply return the name of that state (string) from the <code class="language-plaintext highlighter-rouge">next_state</code> function. Note that the last element of <code class="language-plaintext highlighter-rouge">child_states</code> is special in that return this will exit the SimpleStateMachine.</p>
  </li>
  <li>
    <p>The transition state also keeps track of the last state that was executed inside the <code class="language-plaintext highlighter-rouge">self.last_state</code> variable. If the logic of where to go next relies on what you executed last, this variable would be useful. Note that its value is <code class="language-plaintext highlighter-rouge">None</code> by default if the program has yet to enter any of the child states.</p>
  </li>
  <li>
    <p>Unlike a <a href="#state">state</a>, the <code class="language-plaintext highlighter-rouge">self.tear_down</code> function gets executed when the entire SimpleStateMachine is exited (and not every time the transition state exits, which wouldn’t add a lot of value). Any tear down functionality should go inside this function e.g. resetting any member variables.</p>
  </li>
</ul>

<h4 id="recipes">Recipes</h4>

<p>Recipes are probably the main contribution of shef. They allow us to quickly define a finite state machine which is then parsed and executed automatically when the program is run. A recipe file is nothing but a simple <code class="language-plaintext highlighter-rouge">.yml</code> file with information about constructing a state machine.</p>

<p>Here is an example:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre>    <span class="na">root</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">SimpleStateMachine</span>
      <span class="na">transition_state</span><span class="pi">:</span> <span class="s">SequentialTransitionState</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">child_1</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
            <span class="na">child_states</span><span class="pi">:</span>
                <span class="na">parallel_1</span><span class="pi">:</span>
                    <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
                <span class="na">parallel_2</span><span class="pi">:</span>
                    <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
        <span class="na">child_2</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><strong>Explanation</strong>:</p>

<p>This recipe file will create a state machine called <code class="language-plaintext highlighter-rouge">root</code> which is of type <a href="#simplestatemachine">SimpleStateMachine</a> and has 2 child states: <code class="language-plaintext highlighter-rouge">child_1</code> and <code class="language-plaintext highlighter-rouge">child_2</code>. The <code class="language-plaintext highlighter-rouge">SequentialTransitionState</code> dictates the control flow between these child states. <code class="language-plaintext highlighter-rouge">child_1</code> in itself is a state machine of type <a href="#concurrentstatemachine">ConcurrentStateMachine</a> while <code class="language-plaintext highlighter-rouge">child_2</code> is just a regular <a href="#state">state</a> of type <code class="language-plaintext highlighter-rouge">DummyState</code>.</p>

<h5 id="defining-your-own-recipes">Defining your own recipes</h5>

<p>Recipe files follow a tree structure and writing one is quite straightforward. There are only a handful of things to keep in mind:</p>

<p><strong>1. <code class="language-plaintext highlighter-rouge">&lt;state names&gt;</code> vs <code class="language-plaintext highlighter-rouge">&lt;keywords&gt;</code> vs <code class="language-plaintext highlighter-rouge">&lt;class names&gt;</code></strong></p>

<ul>
  <li>There are a few words that have special meaning. We’ll call them <code class="language-plaintext highlighter-rouge">&lt;keywords&gt;</code>. In the example above <code class="language-plaintext highlighter-rouge">type</code>, <code class="language-plaintext highlighter-rouge">transition_state</code> and <code class="language-plaintext highlighter-rouge">child_states</code> are all keywords. In addition, <code class="language-plaintext highlighter-rouge">import</code> is also a keyword.</li>
  <li>A <code class="language-plaintext highlighter-rouge">&lt;state name&gt;</code> is, well, the name of a state or state machine being defined. In the example above <code class="language-plaintext highlighter-rouge">root</code>, <code class="language-plaintext highlighter-rouge">child_1</code>, <code class="language-plaintext highlighter-rouge">child_2</code>, <code class="language-plaintext highlighter-rouge">parallel_1</code> and <code class="language-plaintext highlighter-rouge">parallel_2</code> are all state names. These can be whatever you want.</li>
  <li><code class="language-plaintext highlighter-rouge">type</code> and <code class="language-plaintext highlighter-rouge">transition_state</code> keywords have values, which are <code class="language-plaintext highlighter-rouge">&lt;class names&gt;</code>. The parser will use this to instantiate a class with the matching name. Therefore, it is important to make sure that the <code class="language-plaintext highlighter-rouge">&lt;class name&gt;</code> is spelt correctly and there is in fact a class defined with the corresponding name. <em>Note: this class must be exposed in the <code class="language-plaintext highlighter-rouge">/state_machine/states/__init__.py</code> file.</em></li>
</ul>

<p><strong>2. <code class="language-plaintext highlighter-rouge">type</code></strong></p>

<p>There are only 2 types of <em>state machines</em>: <code class="language-plaintext highlighter-rouge">SimpleStateMachine</code> and <code class="language-plaintext highlighter-rouge">ConcurrentStateMachine</code>. For both of these, you will need to define the <code class="language-plaintext highlighter-rouge">child_states</code>. In addition, for a <code class="language-plaintext highlighter-rouge">SimpleStateMachine</code>, you will also need to specify the <code class="language-plaintext highlighter-rouge">transition_state</code>.</p>

<p>Everything else that is not a state machine, is a <a href="#state">simple state</a>. For these you only need to define the <code class="language-plaintext highlighter-rouge">type</code> as <code class="language-plaintext highlighter-rouge">&lt;class name&gt;</code>. These states cannot have <code class="language-plaintext highlighter-rouge">child_states</code>.</p>

<p><strong>3. Each recipe file defines a single top-level state machine</strong></p>

<p>Going back to the idea of recipe files following a tree structure, each file must only define a single state or state machine at the top level. This is akin to the idea of a tree having a single root.</p>

<p>Here is an example of what you <strong>cannot</strong> do:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>    <span class="na">my_custom_state_machine_1</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">SimpleStateMachine</span>
      <span class="na">transition_state</span><span class="pi">:</span> <span class="s">SequentialTransitionState</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">child_1</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
    <span class="na">my_custom_state_machine_2</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">SimpleStateMachine</span>
      <span class="na">transition_state</span><span class="pi">:</span> <span class="s">SequentialTransitionState</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">child_1</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>On the other hand, here are some examples of <strong>valid</strong> recipes:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>    <span class="na">my_custom_state_machine</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">child_1</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
        <span class="na">child_2</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
        <span class="na">child_3</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>   
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>    <span class="na">my_custom_state</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
</pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre>    <span class="na">my_top_state_machine</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">my_custom_state_machine_1</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">SimpleStateMachine</span>
          <span class="na">transition_state</span><span class="pi">:</span> <span class="s">SequentialTransitionState</span>
          <span class="na">child_states</span><span class="pi">:</span>
            <span class="na">child_1</span><span class="pi">:</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
        <span class="na">my_custom_state_machine_2</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">SimpleStateMachine</span>
          <span class="na">transition_state</span><span class="pi">:</span> <span class="s">SequentialTransitionState</span>
          <span class="na">child_states</span><span class="pi">:</span>
            <span class="na">child_1</span><span class="pi">:</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><strong>4. Each child state of a given state machine must have a unique <code class="language-plaintext highlighter-rouge">&lt;state name&gt;</code></strong></p>

<p>The following recipe is <strong>not</strong> okay</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre>    <span class="na">my_custom_state_machine</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
      <span class="na">child_states</span><span class="pi">:</span>
          <span class="na">child_1</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
          <span class="na">child_1</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>but this one is (even though two states share the same state name)</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre>    <span class="na">my_custom_state_machine</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">child_1</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
          <span class="na">child_states</span><span class="pi">:</span>
            <span class="na">same_name</span><span class="pi">:</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
        <span class="na">child_2</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
          <span class="na">child_states</span><span class="pi">:</span>
            <span class="na">same_name</span><span class="pi">:</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><strong>5. Indentation matters</strong></p>

<p>After every <code class="language-plaintext highlighter-rouge">&lt;state name&gt;:</code> and <code class="language-plaintext highlighter-rouge">child_states:</code> you’ll need to indent. This is standard yaml stuff.</p>

<p><strong>6. Nesting recipe files</strong></p>

<p>Because of the indentation and nesting state machines, some of the recipe files can get really hairy. To allow for sanity and reusability, you can nest recipe files using the <code class="language-plaintext highlighter-rouge">import</code> keyword,</p>

<p>Consider the following recipe file:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>    <span class="c1"># filename: child_recipe.yml</span>
    <span class="na">i_am_root</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">child_1</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
        <span class="na">child_2</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>which is imported inside another recipe file as:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre>    <span class="c1"># filename: parent_recipe.yml</span>
    <span class="na">root</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">i_am_not_root</span><span class="pi">:</span>
          <span class="na">import</span><span class="pi">:</span> <span class="s">child_recipe</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The above is the equivalent of:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre>    <span class="c1"># filename: same_as_parent_recipe.yml</span>
    <span class="na">root</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">i_am_not_root</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
          <span class="na">child_states</span><span class="pi">:</span>
            <span class="na">child_1</span><span class="pi">:</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
            <span class="na">child_2</span><span class="pi">:</span>
              <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Notice how the state name <code class="language-plaintext highlighter-rouge">i_am_root</code> disappears in the <code class="language-plaintext highlighter-rouge">same_as_parent_recipe.yml</code>.</p>

<p>If you run <code class="language-plaintext highlighter-rouge">child_recipe.yml</code> as the main recipe, the top level state machine <em>will</em> have the name <code class="language-plaintext highlighter-rouge">i_am_root</code> but if you run <code class="language-plaintext highlighter-rouge">parent_recipe.yml</code>, the imported state machine has the name <code class="language-plaintext highlighter-rouge">i_am_not_root</code>.</p>

<p>Note: When importing a recipe file into another, you must define a <code class="language-plaintext highlighter-rouge">&lt;state name&gt;</code> for it in the parent recipe file. For instance, here is an example of something you <strong>cannot</strong> do.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre>    <span class="c1"># filename: bad_parent_recipe.yml</span>
    <span class="na">root</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">import</span><span class="pi">:</span> <span class="s">child_recipe</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This is mandated to ensure that you can import the same recipe file multiple times within the same state machine e.g.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>    <span class="c1"># filename: good_parent_recipe.yml</span>
    <span class="na">root</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
      <span class="na">child_states</span><span class="pi">:</span>
        <span class="na">child_1</span><span class="pi">:</span>
          <span class="na">import</span><span class="pi">:</span> <span class="s">child_recipe</span>
        <span class="na">child_2</span><span class="pi">:</span>
          <span class="na">import</span><span class="pi">:</span> <span class="s">child_recipe</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h4 id="monitor">Monitor</h4>

<p>Each <a href="#simplestatemachine">simple state machine</a> and <a href="#concurrentstatemachine">concurrent state machine</a> comes with a monitor state. As mentioned earlier, the monitor state sets up a unique rostopic for each state machine and constantly listens to it for any messages. The idea is that a given state machine can be preempted or forced to execute a particular state by publishing a message to this monitor.</p>

<p>Note: Preemption applies to both <a href="#simplestatemachine">simple state machine</a> and <a href="#concurrentstatemachine">concurrent state machine</a>. However, forced child state execution applies only to <a href="#simplestatemachine">simple state machine</a>.</p>

<p>Consider the following recipe file:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre>  <span class="na">root</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
    <span class="na">child_states</span><span class="pi">:</span>  
      <span class="na">parallel_1</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">SimpleStateMachine</span>
        <span class="na">transition_state</span><span class="pi">:</span> <span class="s">LoopTransitionState</span>
        <span class="na">child_states</span><span class="pi">:</span>
          <span class="na">child_1</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
          <span class="na">child_2</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
          <span class="na">child_3</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
          <span class="na">child_4</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">DummyState</span>
      <span class="na">parallel_2</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">SomeOtherState</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Executing this recipe file will set up the following rostopics</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/root_monitor</code></li>
  <li><code class="language-plaintext highlighter-rouge">/root/parallel_1_monitor</code></li>
</ul>

<p>Let’s say you want to force <code class="language-plaintext highlighter-rouge">parallel_1</code> to execute <code class="language-plaintext highlighter-rouge">child_3</code> except when it is executing <code class="language-plaintext highlighter-rouge">child_1</code> (which for some reason you do not want to interrupt), you can do so using:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre>  <span class="kn">import</span> <span class="nn">rospy</span>
  <span class="kn">from</span> <span class="nn">state_machine.states.base._forced_transition_message</span> <span class="kn">import</span> <span class="n">ForcedTransitionMessage</span>

  <span class="n">parallel_1_publisher</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Publisher</span><span class="p">(</span>
              <span class="s">"/root/parallel_1_monitor"</span><span class="p">,</span>
              <span class="n">String</span><span class="p">,</span>
              <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
          <span class="p">)</span>

  <span class="n">force_parallel_1_message</span> <span class="o">=</span> <span class="n">ForcedTransitionMessage</span><span class="p">(</span>
      <span class="n">access_control</span><span class="o">=</span><span class="s">"ignore_if_in_given_states"</span><span class="p">,</span>
      <span class="n">potential_current_states</span><span class="o">=</span><span class="p">[</span><span class="s">"child_1"</span><span class="p">],</span>
      <span class="n">target_state</span><span class="o">=</span><span class="s">"child_3"</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">parallel_1_publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">force_parallel_1_message</span><span class="p">.</span><span class="n">to_json</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Alternatively, let’s say you wanted to preempt/kill the <code class="language-plaintext highlighter-rouge">root</code> state machine, you could do so using:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre>  <span class="kn">import</span> <span class="nn">rospy</span>
  <span class="kn">from</span> <span class="nn">state_machine.states.base._forced_transition_message</span> <span class="kn">import</span> <span class="n">ForcedTransitionMessage</span>

  <span class="n">root_publisher</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Publisher</span><span class="p">(</span>
              <span class="s">"/root_monitor"</span><span class="p">,</span>
              <span class="n">String</span><span class="p">,</span>
              <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
          <span class="p">)</span>

  <span class="n">kill_state_machine_message</span> <span class="o">=</span> <span class="n">ForcedTransitionMessage</span><span class="p">(</span>
      <span class="n">access_control</span><span class="o">=</span><span class="s">"preempt_if_in_given_states"</span><span class="p">,</span>
      <span class="n">potential_current_states</span><span class="o">=</span><span class="p">[],</span>
      <span class="n">target_state</span><span class="o">=</span><span class="s">""</span><span class="p">,</span>
      <span class="n">kill_state_machine</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">root_publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">kill_state_machine_message</span><span class="p">.</span><span class="n">to_json</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Note the access control <code class="language-plaintext highlighter-rouge">"preempt_if_in_given_states"</code> vs <code class="language-plaintext highlighter-rouge">"ignore_if_in_given_states"</code>. We’ve already seen the use of <code class="language-plaintext highlighter-rouge">"ignore_if_in_given_states"</code> which is used to avoid interrupting the state machine if it is executing given <code class="language-plaintext highlighter-rouge">potential_current_states</code>. The use of <code class="language-plaintext highlighter-rouge">"preempt_if_in_given_states"</code> is quite the opposite. Here the state machine will only be interrupted if it is executing one of the given <code class="language-plaintext highlighter-rouge">potential_current_states</code>.</p>

<h4 id="synchronisation">Synchronisation</h4>

<p>Often times when executing a finite state machine there is a need to synchronise various states that are running in concurrence/parallel. For instance, imagine there are two robots performing some task that takes an unpredictable amount of time. Further imagine that these robots need to access a resource after completing the task except only one robot may access the resource at any given time. To ensure that both the robots do not access the resource at the same time, we can write the following recipe:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre>  <span class="na">root</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ConcurrentStateMachine</span>
    <span class="na">child_states</span><span class="pi">:</span>  
      <span class="na">robot_1</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">SimpleStateMachine</span>
        <span class="na">transition_state</span><span class="pi">:</span> <span class="s">SequentialTransitionState</span>
        <span class="na">child_states</span><span class="pi">:</span>
          <span class="na">task</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">TaskActionState</span>
          <span class="na">access_resource</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">AccessResourceActionState</span>
            <span class="na">conditions</span><span class="pi">:</span>
              <span class="na">pre-execution</span><span class="pi">:</span> <span class="pi">[</span>
                <span class="pi">[</span><span class="s2">"</span><span class="s">/root/robot_2/access_resource"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">INACTIVE"</span><span class="pi">]</span>
              <span class="pi">]</span>
      <span class="na">robot_2</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">SimpleStateMachine</span>
        <span class="na">transition_state</span><span class="pi">:</span> <span class="s">SequentialTransitionState</span>
        <span class="na">child_states</span><span class="pi">:</span>
          <span class="na">task</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">TaskActionState</span>
          <span class="na">access_resource</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">AccessResourceActionState</span>
            <span class="na">conditions</span><span class="pi">:</span>
              <span class="na">pre-execution</span><span class="pi">:</span> <span class="pi">[</span>
                <span class="pi">[</span><span class="s2">"</span><span class="s">/root/robot_1/access_resource"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">INACTIVE"</span><span class="pi">]</span>
              <span class="pi">]</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Here the state <code class="language-plaintext highlighter-rouge">access_resource</code> for each robot has a <code class="language-plaintext highlighter-rouge">pre-execution</code> condition that makes sure that a given state (of the other robot) is <code class="language-plaintext highlighter-rouge">INACTIVE</code>. shef will continue to busy-wait until this condition is true before entering the state.</p>

<p><strong>YSK</strong></p>

<ul>
  <li>There are two types of conditions: <code class="language-plaintext highlighter-rouge">pre-execution</code> and <code class="language-plaintext highlighter-rouge">post-execution</code>. Their behaviour is exactly what their name suggests.</li>
  <li>Each <code class="language-plaintext highlighter-rouge">pre-execution</code> or <code class="language-plaintext highlighter-rouge">post-execution</code> condition is a actually a list of multiple states to wait-for.</li>
  <li>You can condition on each state being <code class="language-plaintext highlighter-rouge">ACTIVE</code> or <code class="language-plaintext highlighter-rouge">INACTIVE</code>, or for them to <code class="language-plaintext highlighter-rouge">ENTER</code> or <code class="language-plaintext highlighter-rouge">EXIT</code>.</li>
</ul>

<h4 id="final-remarks">Final Remarks</h4>

<p>Phew! There is a lot to process, and honestly this post doesn’t cover everything there is to know about shef. I encourage you to play around with it and I hope that this post was enough to get you started.</p>

<p>Until next time!</p>

  </article>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname  = 'ragavsachdeva';
      var disqus_identifier = '/posts/2021/shef';
      var disqus_title      = "shef - bake state machines in ROS";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2025 Ragav  Sachdeva.
    
    
  </div>
</footer>



  </body>

  <!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  

<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>

<!-- Load DarkMode JS -->
<script src="/assets/js/dark_mode.js"></script>


</html>
